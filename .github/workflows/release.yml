name: Build and Release ZIP

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install --no-audit --no-fund

      - name: Build assets
        run: |
          node node_modules/webpack/bin/webpack.js --mode production

      - name: Create clean ZIP from tag
        shell: bash
        run: |
          TAG_NAME="${GITHUB_REF##*/}"
          ZIP_NAME="seo-page-monitor-${TAG_NAME}.zip"
          # Use .gitattributes export-ignore to create lean archive
          git archive --format zip --output "$ZIP_NAME" "$TAG_NAME"
          ls -lah "$ZIP_NAME"

      - name: Extract changelog section from README
        id: changelog
        shell: bash
        run: |
          set -euo pipefail
          TAG_NAME="${GITHUB_REF##*/}"
          VER_NO_V="${TAG_NAME#v}"
          BODY_FILE="RELEASE_BODY.md"
          # Extract lines between "### <version>" and next "###" or EOF
          awk -v ver="$VER_NO_V" '
            BEGIN{found=0}
            /^###[[:space:]]+/{
              if(found==1){exit}
              if($0 ~ "^###[[:space:]]+" ver "$"){found=1; print}
              next
            }
            { if(found==1) print }
          ' README.md > "$BODY_FILE" || true
          # If empty, write a fallback body
          if [ ! -s "$BODY_FILE" ]; then
            printf "Automated release for %s.\nSee README.md for changelog details." "$TAG_NAME" > "$BODY_FILE"
          fi
          echo "body_path=$BODY_FILE" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ github.ref_name }}
          tag_name: ${{ github.ref_name }}
          generate_release_notes: true
          body_path: ${{ steps.changelog.outputs.body_path }}
          files: |
            seo-page-monitor-${{ github.ref_name }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
